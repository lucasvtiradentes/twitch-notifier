!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).TwitchNotifier=e()}(this,(function(){"use strict";return class{constructor(t){this.config=t,this.VERSION="1.1.0",this.APPNAME="twitch-notifier",this.GITHUB_REPOSITORY="lucasvtiradentes/twitch-notifier",this.ENVIRONMENT=this.detectEnvironment(),this.CURRENT_DATETIME=this.getDatefixedByTimezone(new Date).toISOString(),this.SESSION_LOGS=[],this.USER_EMAIL=this.getUserEmail(),this.PROPERTY_DIVIDER=" | ",this.APPS_SCRIPTS_PROPERTIES={lastNotify:"LAST_NOTIFY"},this.ERRORS={productionOnly:"This method cannot run in non-production environments",mustSpecifyConfig:"You must specify the settings when starting the class",httpsError:"You provided an invalid ICS calendar link: "},this.validateConfigs(t),this.config=t,this.logger(`${this.APPNAME} is running at version ${this.VERSION} in ${this.ENVIRONMENT} environment`),this.logger(`check the docs for your version here: https://github.com/${this.GITHUB_REPOSITORY}/tree/v${this.VERSION}#readme`)}validateConfigs(t){if(!t)throw new Error(this.ERRORS.mustSpecifyConfig);[{objToCheck:t,requiredKeys:["twitch","settings"],name:"configs"},{objToCheck:t.twitch,requiredKeys:["channels","ignoredWords","maximumUptimeMinutes"],name:"configs.twitch"},{objToCheck:t.settings,requiredKeys:["timeZoneCorrection","disabledHours","checkFunction","minutesBetweenChecks"],name:"configs.settings"}].forEach((t=>{const{objToCheck:e,requiredKeys:i,name:r}=t;i.forEach((t=>{if(!e||!Object.keys(e).includes(t))throw new Error(`missing key in ${r}: ${t}`)}))})),this.config.twitch.channels.forEach((t=>{if(t[1].ignoredWords&&t[1].searchedWords)throw new Error(`you must specify only one filter parameter in channel [${t[0]}]: ignoredWords OR searchedWords`)}))}detectEnvironment(){return"object"==typeof MailApp?"google_apps_script":"object"==typeof window?"browser":"nodejs"}logger(t){this.SESSION_LOGS.push(t),console.log(t)}getDateFixedByTimezone(t){const e=new Date;return e.setHours(e.getHours()+t),e}getDatefixedByTimezone(t){return t.setHours(t.getHours()+-3),t}getMinutesDiff(t,e){return Math.floor(Math.abs(Number(this.getDatefixedByTimezone(new Date(e)))-Number(this.getDatefixedByTimezone(new Date(t))))/1e3/60)}getScriptFunction(){if("google_apps_script"!==this.ENVIRONMENT)throw new Error(this.ERRORS.productionOnly);return ScriptApp}getPropertyFunction(){if("google_apps_script"!==this.ENVIRONMENT)throw new Error(this.ERRORS.productionOnly);return PropertiesService}getFetchFunction(){if("google_apps_script"!==this.ENVIRONMENT)throw new Error(this.ERRORS.productionOnly);return UrlFetchApp.fetch}getEmailFunction(){if("google_apps_script"!==this.ENVIRONMENT)throw new Error(this.ERRORS.productionOnly);return MailApp.sendEmail}getContent(t){return new Promise((e=>{require("https").get(t,(t=>{let i="";t.on("data",(t=>{i+=t})),t.on("end",(()=>{e(i)}))}))}))}async getPageContent(t){let e="";if("google_apps_script"===this.ENVIRONMENT){e=this.getFetchFunction()(t).getContentText()}else"nodejs"===this.ENVIRONMENT&&(e=await this.getContent(t));return e}generateEmailContent(t){let e="";const i='style="width: 100%; text-align: center;"',r='style="border: 1px solid #333"',s=`<center>\n<table style="border: 1px solid #333; width: 90%">\n${`<tr ${i}">\n<th ${r} width="100px">channel</th><th ${r} width="100px">uptime</th><th ${r} width="auto">details</th>\n</tr>`}\n${t.map((t=>`<tr ${i}">\n${[`<div style="text-align: center;"><a href="${t.streamLink}"><img src="${t.streamImage}" width="80" style="border-radius: 50%"></a><br><a href="${t.streamLink}">${t.streamName}</a></div>`,`${t.streamLiveUptimeParsed}`,`<div><img src="${t.streamLivePreviewImage}" width="60%"><br><p>${t.streamLiveDescription}</p></div>`].map((t=>`<td ${r}>&nbsp;&nbsp;${t}</td>`)).join("\n")}\n</tr>`)).join("")}\n</table>\n</center>`;return e+="Hi,<br><br>\n",e=e+(1===t.length?`${t[0].streamName} is live:`:"the following channels are live:")+" <br><br>\n",e+=`${s}<br>\n`,e+='Regards, <br>your <a href="https://github.com/lucasvtiradentes/twitch-notifier#readme"><b>twitch notifier</b></a> bot',e}getUserEmail(){return"google_apps_script"===this.ENVIRONMENT?Session.getActiveUser().getEmail():""}sendEmail(t){const e=`Twitch notifier - ${t[0].streamName} is live`,i=`Twitch notifier - ${t.length} channels live: ${t.map((t=>t.streamName)).slice(0,5).join(", ")}`;this.getEmailFunction()({to:this.USER_EMAIL,subject:1===t.length?e:i,htmlBody:this.generateEmailContent(t)})}addAppsScriptsTrigger(t,e){const i=this.getScriptFunction();i.getProjectTriggers().find((e=>e.getHandlerFunction()===t))&&this.removeAppsScriptsTrigger(t),i.newTrigger(t).timeBased().everyMinutes(e).create()}removeAppsScriptsTrigger(t){const e=this.getScriptFunction(),i=e.getProjectTriggers().find((e=>e.getHandlerFunction()===t));if(i)return e.deleteTrigger(i),!0}removeAppsScriptProperty(t){if(this.getAppsScriptProperty(t))return this.getPropertyFunction().getScriptProperties().deleteProperty(t),!0}getAppsScriptProperty(t){return this.getPropertyFunction().getScriptProperties().getProperty(t)}updateAppsScriptProperty(t,e){return this.getPropertyFunction().getScriptProperties().setProperty(t,e)}addMissingProperties(){this.getAppsScriptProperty(this.APPS_SCRIPTS_PROPERTIES.lastNotify)||this.updateAppsScriptProperty(this.APPS_SCRIPTS_PROPERTIES.lastNotify,"")}getTwitchLink(t){return`https://www.twitch.tv/${t}`}async getTwitchStreamCompleteInfo(t){const e=await this.getPageContent(this.getTwitchLink(t));return this.extractLiveInformation(e,t)}extractLiveInformation(t,e){var i,r,s;let n=t.split('<script type="application/ld+json">')[1],o="";n&&(o=t.split('content="https://static-cdn')[1],o="https://static-cdn"+o.split('"')[0],n=n.split("<\/script>")[0],n=JSON.parse(n),n=n[0]);const a=n,h=a?this.getDatefixedByTimezone(new Date(a.uploadDate)).toISOString():"",c=this.getMinutesDiff(new Date(this.CURRENT_DATETIME),new Date(h));return{streamName:e,streamLink:this.getTwitchLink(e),streamImage:o,streamIsLive:null!==(i=null==a?void 0:a.publication.isLiveBroadcast)&&void 0!==i&&i,streamLiveDescription:null!==(r=null==a?void 0:a.description)&&void 0!==r?r:"",streamLivePreviewImage:null!==(s=null==a?void 0:a.thumbnailUrl[2])&&void 0!==s?s:"",streamLiveStartDatetime:h,streamLiveUptimeMinutes:c,streamLiveUptimeParsed:c>60?`${Math.trunc(c/60)} hours<br>${c-60*Math.trunc(c/60)} minutes`:!1===isNaN(c)?`${c} minutes`:""}}updateNotifiedChannels(t){const e=[...this.getLastNotifiedChannels().filter((e=>!1===t.map((t=>t.streamName)).includes(e[0]))),...t.map((t=>[t.streamName,this.CURRENT_DATETIME]))].map((t=>t.join(this.PROPERTY_DIVIDER))).filter((t=>t.length>0)).join("\n");this.updateAppsScriptProperty(this.APPS_SCRIPTS_PROPERTIES.lastNotify,e)}showNextChannelsToNotify(t){const e=t.map((t=>[t.streamName,t.streamIsLive,t.streamLiveUptimeMinutes])).sort(((t,e)=>Number(e[1])-Number(t[1]))),i=Math.max(...e.map((t=>t[0].toString().length)));return e.map((t=>`${t[0]}${" ".repeat(i-t[0].toString().length)} - ${t[1]?"online ":"offline"}${isNaN(Number(t[2]))?"":" - "+Number(Number(t[2])/60).toFixed(2)+" hours"}`)).join("\n")}getLastNotifiedChannels(){if("google_apps_script"!==this.ENVIRONMENT)return[];return this.getAppsScriptProperty(this.APPS_SCRIPTS_PROPERTIES.lastNotify).split("\n").filter((t=>t.length>0)).map((t=>t.split(this.PROPERTY_DIVIDER)))}filterStreamersToNotify(t){let e=[];const i=this.getLastNotifiedChannels();return e=t.filter((t=>t.streamIsLive)),e=e.filter((t=>this.config.twitch.ignoredWords.map((t=>t.toLowerCase())).every((e=>-1===t.streamLiveDescription.toLowerCase().search(e))))),e=e.filter((t=>{const e=this.config.twitch.channels.find((e=>e[0]===t.streamName));return!e[1].ignoredWords||e[1].ignoredWords.map((t=>t.toLowerCase())).every((e=>-1===t.streamLiveDescription.toLowerCase().search(e)))})),e=e.filter((t=>{const e=this.config.twitch.channels.find((e=>e[0]===t.streamName));return!e[1].searchedWords||e[1].searchedWords.map((t=>t.toLowerCase())).some((e=>t.streamLiveDescription.toLowerCase().search(e)>-1))})),e=e.filter((t=>!i.map((t=>t[0])).includes(t.streamName)||t.streamLiveUptimeMinutes<this.config.twitch.maximumUptimeMinutes)),e=e.filter((t=>!1===i.filter((t=>this.getMinutesDiff(this.getDatefixedByTimezone(new Date),new Date(t[1]))<60*this.MIN_HOURS_BETWEEN_NOTIFICATIONS)).map((t=>t[0])).includes(t.streamName))),e}async getTwichStreamersData(){return await Promise.all(this.config.twitch.channels.map((t=>t[0])).map((async t=>await this.getTwitchStreamCompleteInfo(t))))}async check(){const t=Number(this.CURRENT_DATETIME.split("T")[1].split(":")[0]);if(this.config.settings.disabledHours.includes(t))return void this.logger(`skipping run since it [${t}] is a disable hour`);this.addMissingProperties();const e=await this.getTwichStreamersData(),i=this.filterStreamersToNotify(e);i.length>0?(this.sendEmail(i),this.updateNotifiedChannels(i),this.logger(`notified about ${i.length} live streamers`)):(this.logger("no streamers went live recently"),this.logger(this.showNextChannelsToNotify(e)))}setup(){this.addAppsScriptsTrigger(this.config.settings.checkFunction,this.config.settings.minutesBetweenChecks),this.addMissingProperties(),this.logger("installed looping")}uninstall(){this.removeAppsScriptProperty(this.APPS_SCRIPTS_PROPERTIES.lastNotify);this.removeAppsScriptsTrigger(this.config.settings.checkFunction)&&this.logger("uninstalled looping")}}}));